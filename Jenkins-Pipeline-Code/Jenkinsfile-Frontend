pipeline {
    agent any

    environment {
        // Jenkins Credentials IDs
        GITHUB_TOKEN = credentials('github-token')
        GCP_ARTIFACT_KEY = credentials('service account for artifact registry')
        GCP_GKE_KEY = credentials('service-account-for-GKE-cluster') // üîπ New GKE cluster service account
        GCP_ARTIFACT_REPO_NAME = credentials('GCP_ARTIFACT_REPO_NAME')

        // Docker image version
        IMAGE_TAG = "v${env.BUILD_NUMBER}"
        PROJECT_ID = "tier-project-475906"
        REGION = "us-central1"
        CLUSTER_NAME = "deploy-cluster-1" // üîπ your GKE cluster name
        CLUSTER_LOCATION = "us-central1-a" // üîπ zone or region where your cluster is deployed
    }

    stages {
        stage('Checkout') {
            steps {
                echo "üîÑ Checking out source code..."
                git(
                    branch: 'master',
                    url: 'https://github.com/avin995599/End-to-End-Kubernetes-Three-Tier-DevSecOps-Project.git',
                    credentialsId: 'github-creds'
                )
            }
        }

        stage('Setup GCP Auth') {
            steps {
                echo "üîê Authenticating with GCP Artifact Registry..."
                withCredentials([file(variable: 'GOOGLE_APPLICATION_CREDENTIALS', credentialsId: 'service account for artifact registry')]) {
                    sh '''
                        gcloud auth activate-service-account --key-file=$GOOGLE_APPLICATION_CREDENTIALS
                        gcloud config set project $PROJECT_ID
                        gcloud auth configure-docker $REGION-docker.pkg.dev --quiet
                    '''
                }
            }
        }

        stage('Build Docker Image') {
            steps {
                script {
                    echo "üèóÔ∏è Building Docker image..."
                    dir('Application-Code/frontend') {
                        sh '''
                            docker build -t $REGION-docker.pkg.dev/$PROJECT_ID/$GCP_ARTIFACT_REPO_NAME/frontend:$IMAGE_TAG .
                        '''
                    }
                }
            }
        }

        stage('Push to Artifact Registry') {
            steps {
                script {
                    echo "üì¶ Pushing image to Artifact Registry..."
                    sh '''
                        docker push $REGION-docker.pkg.dev/$PROJECT_ID/$GCP_ARTIFACT_REPO_NAME/frontend:$IMAGE_TAG
                    '''
                }
            }
        }

        stage('Update Deployment Manifest') {
            environment {
                GIT_REPO_NAME = "End-to-End-Kubernetes-Three-Tier-DevSecOps-Project"
                GIT_USER_NAME = "avin995599"
            }
            steps {
                dir('Kubernetes-Manifests-file/Frontend') {
                    withCredentials([string(credentialsId: 'github-token', variable: 'GITHUB_TOKEN')]) {
                        sh '''
                            git config user.email "amtnet1508@gmail.com"
                            git config user.name "avin995599"

                            echo "Current Build Tag: v${BUILD_NUMBER}"

                            imageTag=$(grep -oP '(?<=frontend:)[^ ]+' deployment.yaml)
                            echo "Old Image Tag: $imageTag"

                            sed -i "s/${imageTag}/v${BUILD_NUMBER}/" deployment.yaml

                            git add deployment.yaml
                            git commit -m "Update deployment image to version v${BUILD_NUMBER}"
                            git push https://${GITHUB_TOKEN}@github.com/${GIT_USER_NAME}/${GIT_REPO_NAME}.git HEAD:master
                        '''
                    }
                }
            }
        }

        stage('Deploy to GKE') {
            steps {
                echo "üöÄ Deploying updated app to GKE cluster..."
                withCredentials([file(variable: 'GOOGLE_APPLICATION_CREDENTIALS', credentialsId: 'service-account-for-GKE-cluster')]) {
                    sh '''
                        # Authenticate with GKE
                        gcloud auth activate-service-account --key-file=$GOOGLE_APPLICATION_CREDENTIALS
                        gcloud config set project $PROJECT_ID

                        # Get cluster credentials
                        gcloud container clusters get-credentials $CLUSTER_NAME --zone $CLUSTER_LOCATION --project $PROJECT_ID

                        # Apply Kubernetes manifests
                        kubectl apply -f Kubernetes-Manifests-file/Frontend/deployment.yaml
                        kubectl apply -f Kubernetes-Manifests-file/Frontend/service.yaml
                    '''
                }
            }
        }
    }

    post {
        success {
            echo "‚úÖ Build, Push, and Deployment successful!"
        }
        failure {
            echo "‚ùå Pipeline failed. Check Jenkins logs for details."
        }
        always {
            echo "üßπ Cleaning up workspace and Docker resources..."
            cleanWs()
        }
    }
}
