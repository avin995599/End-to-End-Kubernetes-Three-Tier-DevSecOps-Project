pipeline {
    agent any

    environment {
        // Jenkins Credentials IDs
        GITHUB_TOKEN = credentials('github-token')
        GCP_ARTIFACT_KEY = credentials('service account for artifact registry')
        GCP_ARTIFACT_REPO_NAME = credentials('GCP_ARTIFACT_REPO_NAME')

        // Docker image version (timestamped)
        IMAGE_TAG = "v${env.BUILD_NUMBER}"
        PROJECT_ID = "tier-project-475906" // Replace with your actual GCP Project ID
        REGION = "us-central1" // Change if your Artifact Registry is in another region
    }

    stages {
        stage('Checkout') {
            steps {
                echo "üîÑ Checking out source code..."
                git(
                    branch: 'master',
                    url: 'https://github.com/avin995599/End-to-End-Kubernetes-Three-Tier-DevSecOps-Project.git',
                    credentialsId: 'github-creds'
                )
            }
        }

        stage('Setup GCP Auth') {
            steps {
                echo "üîê Authenticating with GCP Artifact Registry..."
                withCredentials([file(variable: 'GOOGLE_APPLICATION_CREDENTIALS', credentialsId: 'service account for artifact registry')]) {
                    sh '''
                        gcloud auth activate-service-account --key-file=$GOOGLE_APPLICATION_CREDENTIALS
                        gcloud auth configure-docker $REGION-docker.pkg.dev --quiet
                    '''
                }
            }
        }

        stage('Build Docker Image') {
            steps {
                script {
                    echo "üèóÔ∏è Building Docker image..."
                    dir('Application-Code/frontend') {
                        sh '''
                            docker build -t $REGION-docker.pkg.dev/$PROJECT_ID/$GCP_ARTIFACT_REPO_NAME/frontend:$IMAGE_TAG .
                        '''
                    }
                }
            }
        }

        stage('Push to Artifact Registry') {
            steps {
                script {
                    echo "üì¶ Pushing image to Artifact Registry..."
                    sh '''
                        docker push $REGION-docker.pkg.dev/$PROJECT_ID/$GCP_ARTIFACT_REPO_NAME/frontend:$IMAGE_TAG
                    '''
                }
            }
        }

        stage('Deployment Update') {
    environment {
        GIT_REPO_NAME = "End-to-End-Kubernetes-Three-Tier-DevSecOps-Project"
        GIT_USER_NAME = "avin995599"
    }
    steps {
        dir('Kubernetes-Manifests-file/Frontend') {
            withCredentials([string(credentialsId: 'github-token', variable: 'GITHUB_TOKEN')]) {
                sh '''
                    git config user.email "amtnet1508@gmail.com"
                    git config user.name "avin995599"
                    
                    echo "Current Build Tag: v${BUILD_NUMBER}"
                    
                    # Extract old image tag from YAML (match anything after frontend:)
                    imageTag=$(grep -oP '(?<=frontend:)[^ ]+' deployment.yaml)
                    echo "Old Image Tag: $imageTag"
                    
                    # Replace old tag with new v{BUILD_NUMBER} tag
                    sed -i "s/${imageTag}/v${BUILD_NUMBER}/" deployment.yaml
                    
                    # Commit and push the updated manifest
                    git add deployment.yaml
                    git commit -m "Update deployment image to version v${BUILD_NUMBER}"
                    git push https://${GITHUB_TOKEN}@github.com/${GIT_USER_NAME}/${GIT_REPO_NAME}.git HEAD:master
                '''
            }
        }
    }
}
}


    post {
        success {
            echo "‚úÖ Build and push successful!"
        }
        failure {
            echo "‚ùå Build failed. Check Jenkins logs for details."
        }
        always {
            echo "üßπ Cleaning up workspace and Docker resources..."
            cleanWs()
        }
    }
}
